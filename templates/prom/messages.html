

<script language="javascript">

var curr = -1;

function CheckAll (check){
	var path = document.messages;
	 for (var i=0;i<path.elements.length;i++) {
		e = path.elements[i];
		checkname = "all";
		if(check==2) checkname = "all2";
		if( (e.name!=checkname)  && (e.type=="checkbox") ) {
			 e.checked = path.all.checked;
			 if(check==2) e.checked = path.all2.checked;
		}
	 }
}


function show(which) {
	if(curr != which) {
		eval("mess_val = message_" + which);
		eval("link_val = 'link_" + which + "'");
		curr = which;
	 	document.getElementById("show_mess").innerHTML = mess_val;
		var request = "?m_read&amp;id_num=" + which + "<?php echo $authstr; ?>";
		var execframe = document.getElementById("theframe");
		execframe.src = request.replace(/&amp;/g, '&');
		var readspan = document.getElementById("link_"+which);
		readspan.style.fontWeight = "normal";
	}
	else {
		curr = -1;
		document.getElementById("show_mess").innerHTML = "<!---Hold--->";
	}
}



<?php /* TODO: wtf: why two nested for loops with the same variable? */ ?>
<?php foreach($jmessage as $v): ?>
	<?php foreach($jmessage as $v): ?>
		<?php if($v["read"] == 0 ): ?>
        message_<?php echo $v["id"]; ?> = ' <table class="inputtable">	<tr><th class="acenter">Viewing Message</th></tr><tr><td>	  <form method="post" action="<?php echo $config["sitedir"]; ?><?php echo $main; ?>?messages<?php echo $authstr; ?>">	  <input type="hidden" name="msg_id" value="<?php echo $v["id"]; ?>">	  <input type="hidden" name="msg_src" value="<?php echo $v["from_num"]; ?>">	  <input type="hidden" name="msg_src_name" value="<?php echo $v["from_name"]; ?>">	  <input type="hidden" name="msg_title" value="<?php echo $v["title"]; ?>">	  <input type="hidden" name="msg_body" value="<?php echo escape_javascript($v["msg_escaped"]); ?>">	  <table>	  <tr>	  <td class="aleft">	   <b>From:</b> <?php echo $v["from_name"]; ?> <a href=?profiles&amp;num=<?php echo $v["from_num"]; ?><?php echo $authstr; ?>>(#<?php echo $v["from_num"]; ?>)</a><br>	   <b>Subject:</b> <?php echo $v["title"]; ?><br>	   <b>Date:</b> <?php echo escape_javascript($v["date"]); ?><br>	   <br><tt><?php echo escape_quotes($v["msg"]); ?></tt>	  </td>	  </tr>	  <tr><td><div align="center">	  <input type="submit" name="do_reply" value="Reply">	  <input type="submit" name="do_forward" value="Forward">	  <input type="submit" name="do_delete" value="Delete">	  </div></td></tr>	  </table>	  </form>	  </td></tr><tr><th><hr></th></tr></table> ';
		<?php endif; ?>
	<?php endforeach; ?>
<?php endforeach; ?>

</script>




<table class="inputtable" width="100%">
<tr><th class="acenter">
<a href="<?php echo $main; ?>?messages<?php echo $authstr; ?>"><?php echo $inboxname; ?></a>
</th><th class="acenter">
<a href="<?php echo $main; ?>?sentmail<?php echo $authstr; ?>"><?php echo $sentname; ?></a>
</th></tr>
</table>
<br>
<br>
<?php if($do_reply): ?>
	<form method="post" action="<?php echo $main; ?>?messages<?php echo $authstr; ?>">
	<div>
	Sending Reply To <?php echo $reply_name; ?> <a href=?profiles&amp;num=<?php echo $reply_src; ?><?php echo $authstr; ?>>(#<?php echo $reply_src; ?>)</a><br>
	Message Title: <input type="text" name="msg_title" size="40" value="Re: <?php echo $reply_title; ?>" maxlength="80"><br>
	<input type="hidden" name="msg_replyto" value="<?php echo $reply_id; ?>">
	<input type="hidden" name="msg_dest" value="<?php echo $reply_src; ?>">
	<textarea rows="10" cols="60" name="msg_body"><?php echo $reply_body; ?></textarea><br>
	<input type="submit" name="do_message" value="Send Reply to <?php echo $uera["empire"]; ?> #<?php echo $reply_src; ?>">
	</div>
	</form>
<?php endif; ?>

<?php if($do_forward): ?>
	<form method="post" action="<?php echo $main; ?>?messages<?php echo $authstr; ?>">

	Forward To:<select name="forward_num1" size="1">
	<?php foreach($numbers as $num_go): ?>
	<option value="<?php echo $num_go["num"]; ?>" class="m<?php echo $num_go["color"]; ?>" <?php if($num_go["num"] == -1): ?> selected <?php endif; ?>><?php echo $num_go["num"]; ?> - <?php echo $num_go["empire"]; ?></option>
	<?php endforeach; ?>
	</select><br>


	Forward To:<select name="forward_num2" size="1">
	<?php foreach($numbers as $num_go): ?>
	<option value="<?php echo $num_go["num"]; ?>" class="m<?php echo $num_go["color"]; ?>" <?php if($num_go["num"] == -1): ?> selected <?php endif; ?>><?php echo $num_go["num"]; ?> - <?php echo $num_go["empire"]; ?></option>
	<?php endforeach; ?>
	</select><br>

	Forward To:<select name="forward_num3" size="1">
	<?php foreach($numbers as $num_go): ?>
	<option value="<?php echo $num_go["num"]; ?>" class="m<?php echo $num_go["color"]; ?>" <?php if($num_go["num"] == -1): ?> selected <?php endif; ?>><?php echo $num_go["num"]; ?> - <?php echo $num_go["empire"]; ?></option>
	<?php endforeach; ?>
	</select><br><br><br>




	<div>
	Message Title: <input type="text" name="msg_title" size="40" value="<?php echo $forward_title; ?>" maxlength="80"><br>
	<textarea rows="10" cols="60" name="msg_body"><?php echo $forward_msg; ?></textarea><br>
	<input type="submit" name="send_forward" value="Forward">
	</div>
	</form>
<?php endif; ?>

<div id="show_mess">
<?php if($view!=""): ?>
	<table class="inputtable">
	<tr><th class="acenter">Viewing Message</th></tr><tr><td>
	<?php if($sent==0): ?>
	  <form method="post" action="<?php echo $main; ?>?messages<?php echo $authstr; ?>">

	  <input type="hidden" name="msg_id" value="<?php echo $vmessage["id"]; ?>">
	  <input type="hidden" name="msg_src" value="<?php echo $vmessage["src"]; ?>">
	  <input type="hidden" name="msg_src_name" value="<?php echo $vsrc["empire"]; ?>">
	  <input type="hidden" name="msg_title" value="<?php echo $vmessage["title"]; ?>">
	  <input type="hidden" name="msg_body" value="<?php echo $vmessage["msg_escaped"]; ?>">
	  <table>
	  <tr>
	  <td class="aleft">
	   <b>From:</b> <?php echo $vsrc["empire"]; ?> <a href=?profiles&amp;num=<?php echo $vsrc["num"]; ?><?php echo $authstr; ?>>(#<?php echo $vsrc["num"]; ?>)</a><br>
	   <b>Subject:</b> <?php echo $vmessage["title"]; ?><br>
	   <b>Date:</b> <?php echo $time; ?><br>
	   <br>
	   <tt><?php echo $vmessage["msg"]; ?></tt>
	  </td>
	  </tr>

	  <tr><td><div align="center">
	  <input type="submit" name="do_reply" value="Reply">
	  <input type="submit" name="do_forward" value="Forward">
	  <input type="submit" name="do_delete" value="Delete">
	  </div></td></tr>
	  </table>

	  </form>
	<?php endif; ?>

	<?php if($sent==1): ?>
		  <form method="post" action="<?php echo $main; ?>?messages<?php echo $authstr; ?>">
		  <input type="hidden" name="msg_body" value="<?php echo $smessage["msg_escaped"]; ?>">
		  <input type="hidden" name="msg_id" value="<?php echo $smessage["id"]; ?>">
		  <input type="hidden" name="msg_src_name" value="<?php echo $vsrc["empire"]; ?>">
		  <input type="hidden" name="msg_src" value="<?php echo $smessage["src"]; ?>">
	  	<input type="hidden" name="msg_title" value="<?php echo $smessage["title"]; ?>">
		  <table>
		  <tr>
		  <td class="aleft">
		   <b>To:</b> <?php echo $vsrc["empire"]; ?> <a href=?profiles&amp;num=<?php echo $vsrc["num"]; ?><?php echo $authstr; ?>>(#<?php echo $vsrc["num"]; ?>)</a><br>
		   <b>Subject:</b> <?php echo $smessage["title"]; ?><br>
		   <b>Date:</b> <?php echo $time; ?><br>
		   <br>
		   <tt><?php echo $smessage["msg"]; ?></tt>
		  </td>
		  </tr>

		  <tr><td><div align="center">
		  <?php if($smessage["deleted"] == 0 || $smessage["deleted"] == 2): ?>
		  		  <input type="submit" name="do_revoke" value="Revoke">
		  <?php endif; ?>
		  <input type="submit" name="do_forward" value="Forward">
		  <input type="submit" name="do_delete" value="Delete"></div></td></tr>
		  </table>
	  </form>
	<?php endif; ?>
	</td></tr><tr><th><hr></th></tr></table>
<?php endif; ?>
</div>

<?php if($sent==0 && $prof_target==""): ?>
	<?php if($num_msg>0): ?>

		<form name="messages" method="post" action="<?php echo $main; ?>?messages<?php echo $authstr; ?>"> <?php /* I want access to all the elements therein */ ?>

		<table class="scorestable">
		<tr class="era<?php echo $color; ?>"><th colspan="4"><?php echo $inboxname; ?></th></tr>

		<tr class="era<?php echo $color; ?>">
		<th style="width:30%">
		<a href="<?php echo $main; ?>?messages&amp;order_by=title&amp;asc=<?php echo $title_order; ?><?php echo $authstr; ?>">Title</a>
		</th>

		<th style="width:30%">
		<a href="<?php echo $main; ?>?messages&amp;order_by=from&amp;asc=<?php echo $from_order; ?><?php echo $authstr; ?>">From</a>
		</th>


        <th style="width:15%">
        <a href="<?php echo $main; ?>?messages&amp;order_by=date&amp;asc=<?php echo $date_order; ?><?php echo $authstr; ?>"> Date</a>
        </th>

        <th style="width:15%">
        <input name="all" type="checkbox" value="Check All" onClick="CheckAll(1);">
        </th>

        </tr>
		<?php foreach($message as $sel): ?>
				<tr>
				<?php if($sel["read"]==0): ?>
					<td><a style="font-weight: bold;" id="link_<?php echo $sel["id"]; ?>" href="<?php echo $main; ?>?messages&amp;view=<?php echo $sel["id"]; ?><?php echo $authstr; ?>" onclick="show(<?php echo $sel["id"]; ?>); return false;"><?php echo $sel["title"]; ?></a></td>
					<?php /*<td><a class="new" href="<?php echo $main; ?>?messages&amp;view=<?php echo $sel["id"]; ?><?php echo $authstr; ?>"><?php echo $sel["title"]; ?></a></td>*/ ?>
				<?php endif; ?>
				<?php if($sel["read"]!=0): ?>
					<?php /*<td><a href="JavaScript:show(<?php echo $sel["id"]; ?>)<?php echo $authstr; ?>"><?php echo $sel["title"]; ?></a></td>*/ ?>
					<td><a href="<?php echo $main; ?>?messages&amp;view=<?php echo $sel["id"]; ?><?php echo $authstr; ?>"><?php echo $sel["title"]; ?></a></td>
				<?php endif; ?>
				<td class="acenter"><?php echo $sel["from_name"]; ?> <a href=?profiles&amp;num=<?php echo $sel["from_num"]; ?><?php echo $authstr; ?>>(#<?php echo $sel["from_num"]; ?>)</a></td>
				<td class="acenter"><?php echo $sel["date"]; ?></td>
				<td class="acenter"><input type="checkbox" name="boxes[]" value="<?php echo $sel["id"]; ?>"></td>
				</tr>

		<?php endforeach; ?>

				<tr class="era<?php echo $color; ?>">

				<th style="width:30%">
				<a href="<?php echo $main; ?>?messages&amp;order_by=title&amp;asc=<?php echo $title_order; ?><?php echo $authstr; ?>">Title</a>
				</th>

				<th style="width:30%">
				<a href="<?php echo $main; ?>?messages&amp;order_by=from&amp;asc=<?php echo $from_order; ?><?php echo $authstr; ?>">From</a>
				</th>


		        <th style="width:15%">
		        <a href="<?php echo $main; ?>?messages&amp;order_by=date&amp;asc=<?php echo $date_order; ?><?php echo $authstr; ?>"> Date</a>
		        </th>

		        <th style="width:15%">
		        <input name="all2" type="checkbox" value="Check All" onClick="CheckAll(2);">
		        </th>

        </tr>


		</table>

		<div>
		<br><br>
		<input type="hidden" name="jsenabled">
		
		<input type="submit" name="do_deleteall" value="Delete all messages" onClick="
			temp = window.confirm('Are you sure you want to delete all messages?');
			if(temp == 1) {
				document.forms.messages.jsenabled.value = 'jsenabled';
				document.forms.messages.submit();
			}

			else
				return false;
		">
		
		<input type="submit" name="do_delete_selected" value="Delete selected">
		<input type="submit" name="do_delete_read" value="Delete read messages">
		</div>
		</form>
	<?php endif; ?>

	<?php if($num_msg==0): ?>
		No new messages...<hr>
	<?php endif; ?>
<?php endif; ?>

<?php /* I've decided to make it so that you only have one template... */ ?>


<?php if($sent!=0): ?>
	<?php if($num_msg>0): ?>
		<form name="messages" method="post" action="<?php echo $main; ?>?sentmail<?php echo $authstr; ?>">

		<table class="scorestable">
		<tr class="era<?php echo $color; ?>"><th colspan="4"><?php echo $sentname; ?></th></tr>

		<tr class="era<?php echo $color; ?>">
		<th style="width:30%">
		<a href="<?php echo $main; ?>?sentmail&amp;order_by=title&amp;asc=<?php echo $title_order; ?><?php echo $authstr; ?>">Title</a>
		</th>

		<th style="width:30%">
		<a href="<?php echo $main; ?>?sentmail&amp;order_by=to&amp;asc=<?php echo $to_order; ?><?php echo $authstr; ?>">To</a>
		</th>


        <th style="width:15%">
        <a href="<?php echo $main; ?>?sentmail&amp;order_by=date&amp;asc=<?php echo $date_order; ?><?php echo $authstr; ?>"> Date</a>
        </th>

        <th style="width:15%">
        <input name="all" type="checkbox" value="Check All" onClick="CheckAll(1);">
        </th>

        </tr>

		<?php foreach($sent_message as $s_sel): ?>
				<tr>
				<td> <a href="<?php echo $main; ?>?sentmail&amp;view=<?php echo $s_sel["id"]; ?><?php echo $authstr; ?>"><?php echo $s_sel["title"]; ?></a></td>
				<td class="acenter"><a href="<?php echo $main; ?>?profiles&amp;num=<?php echo $s_sel["to_num"]; ?><?php echo $authstr; ?>"> <?php echo $s_sel["to_name"]; ?> <a href=?profiles&amp;num=<?php echo $s_sel["to_num"]; ?><?php echo $authstr; ?>>(#<?php echo $s_sel["to_num"]; ?>)</a> </td>
				<td class="acenter"><?php echo $s_sel["date"]; ?></td>
				<td class="acenter"><input type="checkbox" name="boxes[]" value="<?php echo $s_sel["id"]; ?>"></td>
				 </td></tr>

		<?php endforeach; ?>

			<tr class="era<?php echo $color; ?>">

			<th style="width:30%">
			<a href="<?php echo $main; ?>?messages&amp;order_by=title&amp;asc=<?php echo $title_order; ?><?php echo $authstr; ?>">Title</a>
			</th>

			<th style="width:30%">
			<a href="<?php echo $main; ?>?messages&amp;order_by=to&amp;asc=<?php echo $to_order; ?><?php echo $authstr; ?>">To</a>
			</th>


	        <th style="width:15%">
	        <a href="<?php echo $main; ?>?messages&amp;order_by=date&amp;asc=<?php echo $date_order; ?><?php echo $authstr; ?>"> Date</a>
	        </th>

	        <th style="width:15%">
	        <input name="all2" type="checkbox" value="Check All" onClick="CheckAll(2);">
	        </th>

        </tr>


		</table>

		<div>
		<br><br>
		<input type="submit" name="do_deleteall" value="Delete all messages">
		<input type="submit" name="do_delete_selected" value="Delete selected">
		</div>
		</form>
	<?php endif; ?>

	<?php if($num_msg==0): ?>
		No sent messages...<hr>
	<?php endif; ?>

<?php endif; ?>

<div style='display:none'><iframe src='about:blank' width='0' height='0' border='0' id='theframe'></iframe></div>



<?php if($sent==0): ?>


<script language="JavaScript">

function updateMsgNames() {
	msgnum = document.frmmsg.msg_dest_num.value;
	nchanged = true
	for (i = 0; i < document.frmmsg.msg_dest.options.length; i++) {
		 if (document.frmmsg.msg_dest.options[i].value == msgnum) {
			document.frmmsg.msg_dest.options[i].selected = true;
			nchanged = false;
		}
	}
	if (nchanged) {
		document.frmmsg.do_message.disabled = true;
	} else {
		document.frmmsg.do_message.disabled = false;
	}
}
function updateMsgNums() {
	document.frmmsg.msg_dest_num.value = document.frmmsg.msg_dest.value;
		document.frmmsg.do_message.disabled = false;
}
</script>


We currently have <?php echo $msgcreds; ?> message credits remaining.<br><br>
<form method="post" action="<?php echo $main; ?>?messages<?php echo $authstr; ?>" name="frmmsg">
<div>

<?php if($clan != 0): ?>
	<INPUT TYPE="checkbox" NAME="allclan"> Message everyone in clan?
	<BR>(If the above box is checked, the below field will be ignored.)<BR>

	We support bbcode, smilies, and automatic URL conversions.<BR><BR>
<?php endif; ?>

Send a message to: <input type="text" value="<?php echo $prof_target; ?>" name="msg_dest_num" size="3" maxlength="4" onChange="updateMsgNames()">
<select name="msg_dest" onClick="updateMsgNums()" class="dkbg">
	<?php foreach($drop as $dropsel): ?>
		<option value="<?php echo $dropsel["num"]; ?>" class="m<?php echo $dropsel["color"]; ?>"<?php if($prof_target == $dropsel["num"]): ?> selected <?php endif; ?>><?php echo $dropsel["num"]; ?> - <?php echo $dropsel["name"]; ?></option>
	<?php endforeach; ?>
</select>

<br>
Message Title: <input type="text" name="msg_title" size="40" maxlength="80">
<br>
<textarea rows="15" cols="60" name="msg_body"></textarea><br>
<input type="submit" name="do_message" value="Send Message">
</div>
</form>

<?php endif; ?>




